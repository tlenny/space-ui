<script type="text/html" id="selectTenant">
  <a class="layui-btn layui-btn-xs" lay-event="edit">选择</a>
</script>

<form class="layui-form" method="get" lay-filter="top">
  <div class="layui-row layui-col-space16">
    <div class="layui-col-md3">
      <div class="layui-input-wrap">
        <select name="envName" id="envName" lay-filter="envName-search" lay-search="">
        </select>
      </div>
    </div>
    <div class="layui-col-md6">
      <div class="layui-input-wrap">
        <input type="text" name="tenantText" id="tenantText" placeholder="请输入租户ID或名称" autocomplete="off"
          class="layui-input">
      </div>
    </div>
    <div class="layui-col-md1">
      <div class="layui-input-wrap">
        <i id="iCopyTenantInfo" class="layui-icon layui-icon-list" style="margin-right:0px; font-size: 20px;"></i>
      </div>
    </div>

</form>

<div style="vertical-align: middle; width: 600px; align-items: center; display: flex; justify-content:center; ">
  <button id="btnLogin" type="button" class="layui-btn-primary layui-btn-lg" , title="用户登录" ,
    style="border-style:hidden;float:right; margin: 10px;"><i class="layui-icon layui-icon-website"
      style="margin-right:0px; font-size: 30px;"></i></button>
  <button id="btnGql" type="button" class="layui-btn-primary layui-btn-lg" , title="GQL查询" ,
    style="border-style:hidden;float:right; margin: 10px;"><i class="layui-icon layui-icon-edge"
      style="margin-right:0px; font-size: 30px;"></i></button>
  <button id="btnLogs" type="button" class="layui-btn-primary layui-btn-lg" , title="日志查询" ,
    style="border-style:hidden;float:right; margin: 10px;"><i class="layui-icon layui-icon-search"
      style="margin-right:0px; font-size: 30px;"></i></button>
  <button id="btnQbos" type="button" class="layui-btn-primary layui-btn-lg" , title="登录QBOS" ,
    style="border-style:hidden;float:right; margin: 10px;"><i class="layui-icon layui-icon-username"
      style="margin-right:0px; font-size: 30px;"></i></button>
  <button id="btnIdentity" type="button" class="layui-btn-primary layui-btn-lg" , title="identity服务" ,
    style="border-style:hidden;float:right; margin: 10px;"><i class="layui-icon layui-icon-menu-fill"
      style="margin-right:0px; font-size: 30px;"></i></button>

</div>


<hr class="layui-border-green">
<table id="env_config" name="env_config" class="layui-hide"></table>




<script>
  layui.use(['form', 'util', 'table'], function () {
    var $ = layui.$;
    var form = layui.form;
    var layer = layui.layer;
    var util = layui.util;
    var table = layui.table;
    var env_list = {};

    $.ajax({
      url: '/q7/env',
      dataType: 'json',
      type: 'GET',
      success: function (result) {
        var select = $("#envName");
        $.each(result, function (index, item) {
          var envName = item.envName;
          var envTitle = item.cn_envName || item.envName;
          select.append(new Option(envTitle, envName));// 下拉菜单里添加元素
          env_list[envName] = item;
        });
        form.render();
      },
      error: function (result) {
        // alert('error');
      }
    });

    var dropdown = layui.dropdown;
    var inst = dropdown.render({
      elem: '#tenantText',
      data: [],
      click: function (obj) {
        this.elem.val(obj.title);
        this.elem.attr('data-id', obj.id)
      }
    });

    $(inst.config.elem).on('input propertychange', function () {
      var elem = $(this);
      var value = elem.val();
      elem.removeAttr('data-id');
      var dataNew = [];
      var envId = $("#envName").val();
      env_info = env_list[envId];
      global_env = env_info['globalEnv'];
      env_type = env_info['type'];
      if (value && value.length > 1 && value.endsWith(' ')) {
        $.ajax({
          url: '/q7/tenant?key=' + encodeURI(value.trim()) + '&global_env=' + global_env + '&env_type=' + env_type,
          dataType: 'json',
          type: 'GET',
          success: function (result) {
            var dataNew = [];
            $.each(result, function (index, item) {
              dataNew.push({ id: item.id, title: item.name });
            });
            dropdown.reloadData(inst.config.id, {
              data: dataNew
            });
          },
          error: function (result) {
            // alert('error');
          }
        });

      } else {
        dropdown.reloadData(inst.config.id, {
          data: []
        });
      }

    });

    $(inst.config.elem).on('blur', function () {
      var elem = $(this);
      var dataId = elem.attr('data-id');
      if (!dataId) {
        elem.val('');
      }
    });

    function mockData(value) {
      return [
        { id: 1, title: value + '1' },
        { id: 2, title: value + '2' }
      ];
      // $.ajax({
      //   url: '/q7/tenant',
      //   dataType: 'json',
      //   type: 'GET',
      //   success: function (result) {
      //     return result;
      //   },
      //   error: function (result) {
      //     alert('error');
      //   }
      // });
    }

    var gotoLinkButtonIds = ['btnLogin', 'btnGql', 'btnLogs', 'btnQbos', 'btnIdentity', 'btnEnvInfo'];
    gotoLinkButtonIds.forEach(function (id) {
      $('#' + id).hover(function () {
        openMsg(id);
      }, function () {
        layer.close(subtips);
      });
      $('#' + id).click(function () {
        var url;
        if (id === 'btnEnvInfo') {
          renderEnvConfigTable(id);
          return;
        } else if (id === 'btnLogin') {
          url = get_login_url();
        } else if (id === 'btnGql') {
          url = get_gql_url();
        } else if (id === 'btnLogs') {
          url = get_env_config_value('日志ELK');
        } else if (id === 'btnQbos') {
          var envId = $("#envName").val();
          envInfo = env_list[envId];
          url = 'https://qbos.';
          if (envInfo['type'] === 'prod') {
            url += '77hub.com/';
          } else {
            url += get_env_config_value('global-gateway');
          }
        } else if (id === 'btnIdentity') {
          var envId = $("#envName").val();
          envInfo = env_list[envId];
          url = 'https://identity.';
          if (envInfo['type'] === 'prod') {
            url += 'cn-northwest-global.77hub.com/';
          } else {
            url += get_env_config_value('global-gateway');
          }
        }
        if (url) {
          window.open(url); 
          return;
        }
        alert('功能暂未开放');
      });
    });

    function get_login_url() {
      var envId = $("#envName").val();
      envInfo = env_list[envId];
      var url = 'https://';
      if (envInfo['type'] == 'prod') {
        url += 'app.77hub.com';
      } else {
        url += get_env_config_value('global-gateway');
      }
      console.log(url);
      return url;
    }

    function get_env_config_value(key) {
      env_config = table.getData('env_config');
      if (env_config) {
        for (var i = 0; i < env_config.length; i++) {
          if (env_config[i].service == key) {
            return env_config[i].serviceAddr;
          }
        }
      }
      return null;
    }

    function get_gql_url() {
      var url = get_env_config_value('Gql工具地址');
      if (url) {
        var tenantText = $('#tenantText').val();
        var tenantId = $('#tenantText').attr('data-id');
        if (tenantId) {
          clusterId = tenantText.split('|')[0].trim();
          var envId = $("#envName").val();
          url = url.replace(envId, clusterId);
          url = url + '?tenantId=' + tenantId;

        }
      }
      return url;
    }

    function openMsg(id) {
      $('#' + id).attr('title')
      subtips = layer.tips($('#' + id).attr('title'), '#' + id, { tips: [3, '#ff6700'], time: 30000 });
    }

    function renderEnvConfigTable(id) {
      // 常规示例
      table.render({
        elem: '#env_config'
        , url: 'q7/env/' + id
        //,contentType: 'application/json' // 参数为 json 格式传递
        // ,page: !0 || { //详细参数可参考 laypage 组件文档
        //   curr: 5
        //   ,groups: 1
        //   ,first: false
        //   ,last: false
        //   ,layout: [] //自定义分页布局
        // }
        // ,height: 300
        // ,cellMinWidth: 80
        , skin: 'nob'
        , even: true
        , size: 'lg'
        , toolbar: false,
        defaultToolbar: false
        , cols: [[
          { field: 'service', title: '配置项', width: 240 }
          , { field: 'serviceAddr', title: '配置内容' }
        ]],
        done: function (res, curr, count) {
          // $('th').hide()
        }
      });
    }

    // 选择环境
    form.on('select(envName-search)', function (data) {
      var envId = $("#envName").val();
      renderEnvConfigTable(envId);
    });

    // 复制租户信息
    $('#iCopyTenantInfo').on('click', function () {
      $('#tenantText').select(); // 选择对象
      document.execCommand("Copy");
    });

  });


</script>